#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOT'
Usage: scripts/release <patch|minor|major|x.y.z|vX.Y.Z> [repo-path] [--apply]

Examples:
  scripts/release patch .
  scripts/release 1.3.0 . --apply

Behavior:
  - Runs smoke checks (lint/typecheck/test/build where present)
  - Calculates next version
  - Dry-run by default; pass --apply to commit + tag
EOT
}

if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

bump="$1"
repo_path="${2:-.}"
apply_flag="${3:-}"

cd "$repo_path"

if [[ ! -f package.json ]]; then
  echo "package.json not found in $repo_path"
  exit 1
fi

if ! git diff --quiet || ! git diff --cached --quiet; then
  echo "Working tree must be clean before release."
  exit 1
fi

"$(dirname "$0")/smoke" .

current_version="$(jq -r '.version' package.json)"
if [[ -z "$current_version" || "$current_version" == "null" ]]; then
  echo "Could not read version from package.json"
  exit 1
fi

if [[ "$bump" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
  next_version="${bump#v}"
else
  next_version="$(node -e "const [maj,min,pat]='$current_version'.split('.').map(Number); const b='$bump'; if(b==='patch') console.log([maj,min,pat+1].join('.')); else if(b==='minor') console.log([maj,min+1,0].join('.')); else if(b==='major') console.log([maj+1,0,0].join('.')); else process.exit(1);")"
fi

if [[ -z "$next_version" ]]; then
  echo "Failed to compute next version"
  exit 1
fi

echo "Current: $current_version"
echo "Next:    $next_version"

echo "Planned commands:"
echo "  npm version $next_version --no-git-tag-version"
echo "  git add package.json package-lock.json CHANGELOG.md"
echo "  git commit -m \"chore(release): v$next_version\""
echo "  git tag v$next_version"

if [[ "$apply_flag" != "--apply" ]]; then
  echo "Dry-run complete. Re-run with --apply to execute."
  exit 0
fi

npm version "$next_version" --no-git-tag-version

git add package.json
[[ -f package-lock.json ]] && git add package-lock.json
[[ -f CHANGELOG.md ]] && git add CHANGELOG.md

git commit -m "chore(release): v$next_version"
git tag "v$next_version"

echo "Release commit and tag created. Push with:"
echo "  git push && git push --tags"
