#!/usr/bin/env bash
set -euo pipefail

root_dir="$(cd "$(dirname "$0")/.." && pwd)"
keep_tmp=0

if [[ "${1:-}" == "--keep-tmp" ]]; then
  keep_tmp=1
fi

cd "$root_dir"

echo "== syntax checks =="
for f in scripts/* templates/projects/github-action/scripts/*; do
  bash -n "$f"
done

echo "== shellcheck =="
if [[ "${CI:-}" == "true" ]]; then
  ./scripts/lint-shell --strict
else
  ./scripts/lint-shell
fi

echo "== baseline checks =="
./scripts/doctor-ci . --strict --report .toolbox/doctor-ci.md

echo "== benchmark smoke =="
./scripts/bench "bash -lc 'echo benchmark >/dev/null'" 3 .toolbox/bench

echo "== scaffold matrix =="
tmpdir="$(mktemp -d)"
./scripts/scaffold ci-node-cli node-cli "$tmpdir" --no-install --force
./scripts/scaffold ci-next next-app "$tmpdir" --no-install --force --all-next-extras
./scripts/scaffold ci-action github-action "$tmpdir" --no-install --force

./scripts/doctor-ci "$tmpdir/ci-node-cli" --strict
./scripts/doctor-ci "$tmpdir/ci-next" --strict
./scripts/doctor-ci "$tmpdir/ci-action" --strict

[[ -f "$tmpdir/ci-next/components/ui/button.tsx" ]]
[[ -f "$tmpdir/ci-next/components/motion/fade-up.tsx" ]]
[[ -f "$tmpdir/ci-next/video/index.ts" ]]
[[ -f "$tmpdir/ci-next/app/api/agent/route.ts" ]]
[[ -f "$tmpdir/ci-next/.storybook/main.ts" ]]
[[ -f "$tmpdir/ci-next/CLAUDE.md" ]]
[[ -f "$tmpdir/ci-next/app/billing/page.tsx" ]]
[[ -f "$tmpdir/ci-next/app/api/stripe/checkout/route.ts" ]]
[[ -f "$tmpdir/ci-next/app/supabase/page.tsx" ]]
[[ -f "$tmpdir/ci-next/lib/supabase/server.ts" ]]
[[ -f "$tmpdir/ci-next/app/docs/page.tsx" ]]
[[ -f "$tmpdir/ci-next/content/docs/getting-started.mdx" ]]

if command -v rg >/dev/null 2>&1; then
  rg -q "^OPENAI_API_KEY=" "$tmpdir/ci-next/.env.example"
  rg -q "^STRIPE_SECRET_KEY=" "$tmpdir/ci-next/.env.example"
  rg -q "^NEXT_PUBLIC_SUPABASE_URL=" "$tmpdir/ci-next/.env.example"
else
  grep -q "^OPENAI_API_KEY=" "$tmpdir/ci-next/.env.example"
  grep -q "^STRIPE_SECRET_KEY=" "$tmpdir/ci-next/.env.example"
  grep -q "^NEXT_PUBLIC_SUPABASE_URL=" "$tmpdir/ci-next/.env.example"
fi

./scripts/profile-apply node-cli "$tmpdir/ci-node-cli" --owner @PetriLahdelma --force
./scripts/profile-apply next-app "$tmpdir/ci-next" --owner @PetriLahdelma --force
./scripts/profile-apply github-action "$tmpdir/ci-action" --owner @PetriLahdelma --force

echo "self-test passed"

if [[ "$keep_tmp" -eq 1 ]]; then
  echo "tmpdir retained: $tmpdir"
else
  rm -rf "$tmpdir"
fi
